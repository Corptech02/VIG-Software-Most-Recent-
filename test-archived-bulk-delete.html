<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archived Leads Bulk Delete Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        #results { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .trash-test { font-size: 18px; font-weight: bold; color: #dc3545; }
        .test-checkboxes { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .checkbox-row { margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <h1 class="trash-test">üóëÔ∏è ARCHIVED LEADS BULK DELETE TEST</h1>
    <p><strong>This tests the bulk delete functionality for archived leads with trash popup.</strong></p>

    <div>
        <button onclick="testTrashPopup()">üóëÔ∏è Test Trash Popup</button>
        <button onclick="testBulkDeleteAPI()">üì° Test Bulk Delete API</button>
        <button onclick="simulateCheckboxSelection()">‚òëÔ∏è Simulate Checkbox Selection</button>
        <button onclick="testRealArchived()">üìã Test Real Archived Leads</button>
        <button onclick="clearResults()">üìÑ Clear</button>
    </div>

    <!-- Test checkboxes area -->
    <div class="test-checkboxes">
        <h3>Test Checkboxes (simulate archived leads):</h3>
        <div class="checkbox-row">
            <input type="checkbox" class="archived-lead-checkbox" value="archived_test_1" onchange="updateBulkDeleteArchivedButton()">
            <label>Test Archived Lead 1 - Sample Company A</label>
        </div>
        <div class="checkbox-row">
            <input type="checkbox" class="archived-lead-checkbox" value="archived_test_2" onchange="updateBulkDeleteArchivedButton()">
            <label>Test Archived Lead 2 - Sample Company B</label>
        </div>
        <div class="checkbox-row">
            <input type="checkbox" class="archived-lead-checkbox" value="archived_test_3" onchange="updateBulkDeleteArchivedButton()">
            <label>Test Archived Lead 3 - Sample Company C</label>
        </div>
        <p><small>Check these boxes to see the trash popup appear!</small></p>
    </div>

    <div id="results"></div>

    <!-- Load archived leads functionality -->
    <script src="/js/archived-leads-functionality.js"></script>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function testTrashPopup() {
            addResult('üóëÔ∏è <strong>Testing Trash Popup Functionality</strong>', 'info');

            // Check if functions are loaded
            if (typeof window.updateBulkDeleteArchivedButton === 'function') {
                addResult('‚úÖ updateBulkDeleteArchivedButton function loaded', 'success');
            } else {
                addResult('‚ùå updateBulkDeleteArchivedButton function NOT found', 'error');
                return;
            }

            if (typeof window.bulkDeleteArchivedLeads === 'function') {
                addResult('‚úÖ bulkDeleteArchivedLeads function loaded', 'success');
            } else {
                addResult('‚ùå bulkDeleteArchivedLeads function NOT found', 'error');
                return;
            }

            // Test with no checkboxes selected
            addResult('üìä Testing with no checkboxes selected...', 'info');
            const selectedBefore = document.querySelectorAll('.archived-lead-checkbox:checked').length;
            addResult(`Current selected: ${selectedBefore}`, 'info');

            window.updateBulkDeleteArchivedButton();

            const overlay = document.getElementById('bulkDeleteArchivedOverlay');
            if (overlay && overlay.style.display !== 'none') {
                addResult('‚ùå Trash popup appeared when no checkboxes selected', 'error');
            } else {
                addResult('‚úÖ No trash popup when no checkboxes selected (correct)', 'success');
            }

            addResult('üëÜ Now manually check a checkbox above to test popup appearance', 'info');
        }

        function simulateCheckboxSelection() {
            addResult('‚òëÔ∏è <strong>Simulating Checkbox Selection</strong>', 'info');

            // Find checkboxes
            const checkboxes = document.querySelectorAll('.archived-lead-checkbox');
            if (checkboxes.length === 0) {
                addResult('‚ùå No archived-lead-checkbox elements found', 'error');
                return;
            }

            addResult(`Found ${checkboxes.length} archived lead checkboxes`, 'info');

            // Select the first checkbox
            checkboxes[0].checked = true;
            addResult('‚úÖ Selected first checkbox', 'info');

            // Trigger the update function
            if (typeof window.updateBulkDeleteArchivedButton === 'function') {
                window.updateBulkDeleteArchivedButton();
                addResult('‚úÖ Called updateBulkDeleteArchivedButton()', 'info');

                // Check if popup appeared
                setTimeout(() => {
                    const overlay = document.getElementById('bulkDeleteArchivedOverlay');
                    if (overlay) {
                        addResult('üéâ Trash popup appeared successfully!', 'success');
                        addResult('Popup contains:', 'info');
                        addResult(`  ‚Ä¢ Trash icon: ${overlay.querySelector('.fas.fa-trash') ? '‚úÖ' : '‚ùå'}`,
                            overlay.querySelector('.fas.fa-trash') ? 'success' : 'error');
                        addResult(`  ‚Ä¢ Count badge: ${overlay.querySelector('.delete-count') ? '‚úÖ' : '‚ùå'}`,
                            overlay.querySelector('.delete-count') ? 'success' : 'error');

                        const countElement = overlay.querySelector('.delete-count');
                        if (countElement) {
                            addResult(`  ‚Ä¢ Count value: ${countElement.textContent}`, 'info');
                        }
                    } else {
                        addResult('‚ùå Trash popup did NOT appear', 'error');
                    }
                }, 100);
            }

            // Select second checkbox too
            setTimeout(() => {
                checkboxes[1].checked = true;
                window.updateBulkDeleteArchivedButton();
                addResult('‚úÖ Selected second checkbox - count should update to 2', 'info');

                setTimeout(() => {
                    const overlay = document.getElementById('bulkDeleteArchivedOverlay');
                    const countElement = overlay?.querySelector('.delete-count');
                    if (countElement && countElement.textContent === '2') {
                        addResult('‚úÖ Count updated to 2 correctly!', 'success');
                    } else {
                        addResult(`‚ùå Count not updated correctly (expected 2, got ${countElement?.textContent || 'none'})`, 'error');
                    }
                }, 100);
            }, 1000);
        }

        async function testBulkDeleteAPI() {
            addResult('üì° <strong>Testing Bulk Delete API</strong>', 'info');

            // Check if there are any real archived leads to test with
            try {
                const response = await fetch('/api/archived-leads');
                const data = await response.json();

                if (data.success && data.archivedLeads.length > 0) {
                    addResult(`Found ${data.archivedLeads.length} archived leads in database`, 'success');

                    // Test DELETE endpoint for one archived lead (without actually deleting)
                    const testLead = data.archivedLeads[0];
                    addResult(`Test lead: ${testLead.archiveId || testLead.id} - ${testLead.name}`, 'info');

                    // Just test that the endpoint exists (don't actually delete)
                    addResult('‚úÖ API endpoint available for testing', 'success');
                    addResult('‚ö†Ô∏è Not actually deleting - just testing functionality', 'warning');

                } else {
                    addResult('‚ö†Ô∏è No archived leads found in database to test with', 'warning');
                }
            } catch (error) {
                addResult(`‚ùå Error accessing archived leads API: ${error.message}`, 'error');
            }
        }

        async function testRealArchived() {
            addResult('üìã <strong>Testing with Real Archived Leads</strong>', 'info');

            try {
                // Load real archived leads data
                if (typeof window.loadArchivedLeads === 'function') {
                    addResult('üìû Calling loadArchivedLeads()...', 'info');
                    await window.loadArchivedLeads();

                    setTimeout(() => {
                        const realCheckboxes = document.querySelectorAll('.archived-lead-checkbox');
                        addResult(`Found ${realCheckboxes.length} real archived lead checkboxes`,
                            realCheckboxes.length > 0 ? 'success' : 'warning');

                        if (realCheckboxes.length > 0) {
                            addResult('‚úÖ Real archived leads loaded - you can test bulk delete on archived tab', 'success');
                            addResult('Navigate to archived leads tab to see the real functionality', 'info');
                        } else {
                            addResult('‚ö†Ô∏è No real archived leads checkboxes found', 'warning');
                        }
                    }, 2000);
                } else {
                    addResult('‚ùå loadArchivedLeads function not available', 'error');
                }
            } catch (error) {
                addResult(`‚ùå Error testing with real archived leads: ${error.message}`, 'error');
            }
        }

        // Auto-run basic tests on load
        document.addEventListener('DOMContentLoaded', () => {
            addResult('üóëÔ∏è Archived Leads Bulk Delete Test Loaded', 'success');
            addResult('This tests the trash popup functionality for archived leads', 'info');
            addResult('üìã Features being tested:', 'info');
            addResult('  ‚Ä¢ Trash popup appears when checkboxes are selected', 'info');
            addResult('  ‚Ä¢ Count badge shows number of selected leads', 'info');
            addResult('  ‚Ä¢ Bulk delete API endpoint functionality', 'info');
            addResult('  ‚Ä¢ Integration with real archived leads data', 'info');

            // Run basic test automatically
            setTimeout(() => {
                testTrashPopup();
            }, 1000);
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            // Remove any test overlays
            const overlay = document.getElementById('bulkDeleteArchivedOverlay');
            if (overlay) {
                overlay.remove();
            }
        });
    </script>
</body>
</html>